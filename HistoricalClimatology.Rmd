---
title: "HistoricalClimatology"
author: "Zoe Schroder"
date: "3/21/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

Journal of Weather and Climate Extremes

The goal of this research is to understand when and where tornado outbreaks occurred prior to the modern record maintained by the Storm Prediction Center. Has the number of outbreaks increased over time? When do they occur most frequently? Where do they occur most frequently? How does our current outbreak climatology compare to the historical record? 

Library the datasets used in this project: 
```{r}
#extrafont::loadfonts(device="win")
suppressMessages(library(ggplot2))
suppressMessages(library(tmap))
suppressMessages(library(sf))
suppressMessages(library(dplyr))
suppressMessages(library(USAboundaries))
suppressMessages(library(lubridate))
suppressMessages(library(maptools))
suppressMessages(library(raster))
```

*****************************************************************************
## Establish Groups and Big Days of at least 6 tornadoes. 

Load the data for the Historical Tornado Dataset. This will include the tornado touchdown locations (`SigTorns`) and the tracks of the tornadoes (`SigTornTracks`). For this research, use the `SigTorns` dataframe. 
```{r, eval = FALSE}
load("HistoricalTornadoes.RData")
```

```{r, eval = FALSE}
SigTorns$mag[SigTorns$mag == "FN"]  <- "F00" 
SigTorns$mag[SigTorns$mag == "FT"]  <- "F00" 
```

Get the state data for the lower 48 using the `us_states` function from the **USAboundaries** package. This will allow the state borders to be added to a map using the *tm_shape* function. 
```{r}
sts <- state.name[!state.name %in% c("Alaska", "Hawaii")]
stateBorders <- us_states(states = sts)
```

Plot the data for the tornado touchdown locations (`SigTorns`). Add a map of the United States. 
```{r, eval = FALSE}
SigTorns <- st_as_sf(SigTorns)

tm_shape(stateBorders) +
  tm_borders(col = "gray70", alpha = 1) +
  tm_compass(size = 3, fontsize = 1, lwd = 2, color.dark = "gray70") +       
  tm_scale_bar(width = .3, size = 0.8, lwd = 1.75, color.dark = "gray70") +
  tm_layout(legend.bg.color = "white", 
            legend.text.size = .75, 
            attr.position = c("left", "bottom"), 
            inner.margins = c(.1, .1, .1, .1)) +
tm_shape(SigTorns, is.master = TRUE, projection = "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs") +
  tm_bubbles(size = 0.1, col = "NARRZtime") +
      tm_layout(legend.title.size = 1.1,
            legend.position = c("right", "bottom"), 
            legend.stack = "horizontal",
            legend.frame = FALSE, 
            legend.text.size = 1, legend.width = -0.2)
```


Determine the distance between tornadoes in space and time. Use a projection, not lat/lon. See https://epsg.io/102004. Extract the coordinates of the start locations as a N by 2 matrix, where N is the number of tornadoes. Also extract the date-time as a vector of class `POSIXct`.
```{r, eval = FALSE}
SigTorns <- st_as_sf(SigTorns)
st_crs(SigTorns) <- 4326
SigTorns <- st_transform(SigTorns, crs = 4326)

space <- st_coordinates(SigTorns)
time <- as.numeric(SigTorns$DateTime)

space[is.na(space)] <- 0
time[is.na(time)] <- 0
```

Next compute pairwise Euclidean distances in space and, separately, in time using the `dist()` function. Divide the spatial distance by 15 so that the values are commensurate with the time 'distance' based on the assumption of 15 meters per second (~34 mph) for an average speed of tornado-generating storms. Compare: Distance from New York to Denver is 2.622 x 10^6 meters. There are 3.154 x 10^7 seconds in a year. This will capture the historic multiday tornado outbreaks. For analysis we want to consider each day in the multiday group separately. As the value of the divisor increases cluster areas get larger. Remove `ds` and `dt` to free memory. Distances are saved as an object of class `dist` containing a vector of length N * (N-1)/2, which is the number of unique point pairs.
```{r, eval = FALSE}
ds <- dist(space) / 15
dt <- dist(time)
dst <- ds + dt
rm(ds, dt)
```

Distances are saved as an object of class `dist` containing a vector of length N * (N-1)/2, which is the number of unique point pairs.

Next group the tornadoes based on the space-time distances. This is done with the `hclust()` (hierarchical cluster) function. Initially, each tornado is assigned to its own group and then the algorithm joins the two closest tornadoes determined by values in `dst`. The algorithm continues by joining tornadoes (and tornado groups) until there is a single large group.

The single linkage method (`method = "single"`) is related to the minimal spanning tree (MST) and adopts a 'friends of friends' grouping strategy. An edge-weighted graph is a graph where each edge has a weight (or cost). Here weights are space-time distances between tornadoes. A MST of an edge-weighted graph is a spanning tree whose weight (the sum of the weights of its edges) is no larger than the weight of any other spanning tree. A spanning tree of a graph on N vertices (tornado centroids) is a subset of N-1 edges that form a tree (Skiena 1990, p. 227).
 
The `cutree()` function is used to extract a group number for each tornado. Tornadoes in each group are close in space & time. Here the tree is cut at a height of 50000 space-time units. Making `h` smaller results in smaller groups (fewer tornadoes per group).
```{r, eval = FALSE}
stime <- proc.time()
tree <- hclust(dst, method = "single")
groupNumber <- as.integer(cutree(tree, h = 50000))
proc.time() - stime
```

```{r, eval = FALSE}
SigTorns$groupNumber <- groupNumber
```

Compute group-level statistics.
```{r, eval = FALSE}
HistoricalGroups.sfdfT <- SigTorns %>%
  group_by(groupNumber) %>%
  summarize(Year = first(yr),
            Month = first(mo),
            FirstDate = min(DateTime),
            LastDate = max(date),
            DateRange = paste(FirstDate, "to", LastDate),
            FirstcDate = min(cDate),
            LastcDate = max(cDate),
            ncD = n_distinct(cDate),
            nT = n(),
            n0 = sum(mag == "F0"),
            n1 = sum(mag == "F1"),
            n2 = sum(mag == "F2"),
            n3 = sum(mag == "F3"),
            n4 = sum(mag == "F4"),
            n5 = sum(mag == "F5"),
            ATP = sum(ED),
            ATP_TW = paste(round(ATP/10^12), "TW"),
            maxEF = max(mag),
            nD = n_distinct(date),
            StartTime = min(DateTime),
            EndTime = max(DateTime),
            Duration = difftime(EndTime, StartTime, units = "secs"), 
            cas = sum(inj + fat, na.rm = TRUE))
```

```{r, eval = FALSE}
HistoricalGroupTornadoes <- SigTorns %>%
  filter(groupNumber %in% HistoricalGroups.sfdfT$groupNumber)
```

########################################
## Extract Big Days from Large Groups ##
########################################

Filter individual tornadoes to remove those that are not part of a large group. Group by group number and convective dates. Remove days having fewer than 10 tornadoes.
```{r, eval = FALSE}
HistoricalBigDays.sfdfT <- SigTorns %>%
  filter(groupNumber %in% HistoricalGroups.sfdfT$groupNumber) %>%
  group_by(groupNumber, cDate) %>%
  summarize(nT = n(),
            n0 = sum(mag == "F0"),
            n1 = sum(mag == "F1"),
            n2 = sum(mag == "F2"),
            n3 = sum(mag == "F3"),
            n4 = sum(mag == "F4"),
            n5 = sum(mag == "F5"),
            maxEF = max(mag),
            ATP = sum(ED),
            maxATP = max(ED),
            avgATP = mean(ED),
            GroupDayCas = sum(cas, na.rm = TRUE),
            GroupDayFat = sum(fat, na.rm = TRUE),
            StartTime = min(DateTime),
            EndTime= max(DateTime),
            Hour = hour(StartTime),
            StartTime_UTC = StartTime + 21600,
            EndTime_UTC = EndTime + 21600,
            Duration = difftime(EndTime, StartTime, units = "secs")) %>%
  filter(nT >= 6) %>%
  mutate(Year = year(cDate),
         Mo = month(cDate),
         Month = format(cDate, "%m"), # this is needed to preserve the leading zeros
         Day = format(cDate, "%d"), 
         ATP_TW = ATP/10^12)                                                                              
dim(HistoricalBigDays.sfdfT)
```
This follows Tippetts paper that defines an outbreak as 6+ torns rated EF1 or higher. 


```{r, eval = FALSE}
#Remove the row with an NA cDate
test <- na.omit(HistoricalBigDays.sfdfT$cDate)

HistoricalBigDays.sfdfT <- HistoricalBigDays.sfdfT %>%
  filter(cDate %in% test)
```


Create a unique ID for each big day and each tornado. Extract the tornadoes associated with each big day using the unique ID.
```{r, eval = FALSE}
HistoricalBigDayTornadoes <- SigTorns %>%
   mutate(ID = paste0(gsub("-", "", cDate), groupNumber))
HistoricalBigDays.sfdfT <- HistoricalBigDays.sfdfT %>%
   mutate(ID = paste0(gsub("-", "", cDate), groupNumber))

HistoricalBigDayTornadoes <- HistoricalBigDayTornadoes %>%
  filter(ID %in% HistoricalBigDays.sfdfT$ID)

sum(HistoricalBigDays.sfdfT$nT)
```

Save the Cluster Data into an .RData object. 
```{r, eval = FALSE}
#save(HistoricalBigDays.sfdfT, HistoricalBigDayTornadoes, HistoricalGroups.sfdfT, HistoricalGroupTornadoes, file = "HistoricalClusters.RData")
```

*****************************************************************************

Load in the Cluster Data of the Historical Tornado Data
```{r}
load("HistoricalClusters.RData")
```

Conduct some data verification. Make sure the calculations are correct between the reported tornadoes and the cluster information.
```{r}
g49 <- HistoricalBigDays.sfdfT %>%
  filter(ID == 1908042349)

g49torns <- HistoricalBigDayTornadoes %>%
  filter(ID == 1908042349)

```

December 3, 1978: Get the magnitude from the SPC dataset. It is an F3. 

om	yr	mo	dy	date	time	tz	st	stf	stn	mag	inj	fat	loss	closs	slat	slon	elat	elon	len	wid	
764	1978	12	3	12/3/1978	2:30:00	3	LA	22	20	3	0	0	0	0	32.7	-93.55	33	-92.58	61.1	10	


April 18, 1880: Coded as FN, but suggests F2 damage. Assign an F2 value to the torn. 


```{r}
HistoricalBigDayTornadoes$mag[HistoricalBigDayTornadoes$mag == "F0"] <- "F2"
HistoricalBigDayTornadoes$mag[HistoricalBigDayTornadoes$mag == "F00"] <- "F3"
```

## Create Figure of Historical Groups: Example of clusters within the data. (A) The largest cluster in the data occurred between XX and XX. (B) The longest cluster in the data occurred between XX and XX. Each circle is a tornado genesis location colored by the day of occurrence. The black line is the minimum convex polygon surrounding all the genesis locations (convex hull)

```{r}
#Remove the "groups" with no time/start date
HistoricalGroups.sfdfT <- HistoricalGroups.sfdfT %>%
  filter(groupNumber != 2)

HistoricalGroupTornadoes <- HistoricalGroupTornadoes %>%
  filter(groupNumber != 2)
```

```{r}
LargeClus <- HistoricalGroups.sfdfT %>%
  filter(groupNumber == 288)
LargeClus <- st_convex_hull(LargeClus)

LargeClusTorns <- HistoricalGroupTornadoes%>%
  filter(groupNumber == 288)
```


```{r}
cr <- RColorBrewer::brewer.pal(9, "Greys")
cr <- cr[-c(1,3)]
```


```{r}
clus1974 <- (tm_shape(stateBorders) + 
  tm_borders(col = "gray70", alpha = 1) +
  tm_compass(size = 3, fontsize = 1, lwd = 2, color.dark = "gray70") +       
  tm_scale_bar(width = .3, size = 0.8, lwd = 1.75, color.dark = "gray70") +
  tm_layout(legend.bg.color = "white", 
            legend.text.size = .75, 
            attr.position = c("left", "bottom"), 
            inner.margins = c(.2, .2, .2, .2)) +
#tm_shape(counties.sf) +
#  tm_borders(col = "gray40", alpha = .3) +
#  tm_scale_bar(width = 8, size = 8, color.dark = "gray70") +
  #tm_format("World", legend.position = c("right", "top"),
#                   attr.position = c("right", "top"),
#                   legend.frame = FALSE,
                   #title = "May 30th Tornado Group",
                   #title.size = 1.3,
                   #title.position = c("left", "TOP"),
 #                  inner.margins = c(.2, .2, .2, .2)) +
tm_shape(LargeClus, is.master = TRUE, projection = "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs") +
  tm_borders(col = "black", lwd = 3) +
tm_shape(LargeClusTorns) +
  tm_symbols(size = 4, col = "cDate", alpha = 0.8, palette = "Blues", title.col = "Convective Day", border.alpha = 0) +
      tm_layout(title = "April 3 - 4, 1974 \n 94 tornadoes", 
              title.position = c("center", "top"), 
              legend.title.size = 1.4,
              legend.position = c("right", "bottom"), 
              legend.stack = "horizontal",
              legend.frame = FALSE, 
              legend.text.size = 1.2, 
              legend.width = -0.3, 
              title.size = 1.5))

```

Longest Cluster: 
```{r}
LongClus <- HistoricalGroups.sfdfT %>%
  filter(groupNumber == 49)
LongClus <- st_convex_hull(LongClus)

LongClusTorns <- HistoricalGroupTornadoes%>%
  filter(groupNumber == 49)
```

```{r}
cr <- RColorBrewer::brewer.pal(9, "Greys")
cr <- cr[-c(1:4)]
```


```{r}
clus1908 <- (tm_shape(stateBorders) + 
  tm_borders(col = "gray70", alpha = 1) +
  tm_compass(size = 3, fontsize = 1, lwd = 2, color.dark = "gray70") +       
  tm_scale_bar(width = .3, size = 0.8, lwd = 1.75, color.dark = "gray70") +
  tm_layout(legend.bg.color = "white", 
            legend.text.size = .75, 
            attr.position = c("left", "bottom"), 
            inner.margins = c(.2, .2, .2, .2)) +
#tm_shape(counties.sf) +
#  tm_borders(col = "gray40", alpha = .3) +
#  tm_scale_bar(width = 8, size = 8, color.dark = "gray70") +
  #tm_format("World", legend.position = c("right", "top"),
#                   attr.position = c("right", "top"),
#                   legend.frame = FALSE,
                   #title = "May 30th Tornado Group",
                   #title.size = 1.3,
                   #title.position = c("left", "TOP"),
 #                  inner.margins = c(.2, .2, .2, .2)) +
tm_shape(LongClus, is.master = TRUE, projection = "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs") +
  tm_borders(col = "black", lwd = 3) +
tm_shape(LongClusTorns) +
  tm_symbols(size = 4, col = "cDate", alpha = 0.8, palette = "Blues", title.col = "Convective Day", border.alpha = 0) +
      tm_layout(title = "April 22 - 25, 1908 \n 32 tornadoes", 
              title.position = c("center", "top"), 
              legend.title.size = 1.4,
              legend.position = c("right", "bottom"), 
              legend.stack = "horizontal",
              legend.frame = FALSE, 
              legend.text.size = 1.2, 
              legend.width = -0.3, 
              title.size = 1.5))

```

```{r}
tmap_arrange(clus1974, clus1908)
```

## Create Table: The total number of large groups and tornadoes by duration.

```{r}
HistoricalGroups.sfdfT %>%
  group_by(ncD) %>%
  summarize(LargeGroups = n(),
            NumTorn = sum(nT, na.rm = TRUE))
```

********************************************************************************
## Big Days: 

What percentage of tornadoes occur in a big day of 6 or more tornadoes?
```{r}
dim(HistoricalBigDayTornadoes)[1]/ dim(HistoricalGroupTornadoes)[1]
```

```{r}
x <- HistoricalBigDays.sfdfT %>%
  group_by(cDate) %>%
  summarize(tot = n())
```


March 27, 1882
ID: 
```{r}
centroids <- st_centroid(HistoricalBigDays.sfdfT)


Mar27 <- HistoricalBigDays.sfdfT %>%
  filter(cDate == "1882-03-27", groupNumber == 4)
Mar27 <- st_convex_hull(Mar27)

Mar27centroid <- centroids %>%
  filter(cDate == "1882-03-27", groupNumber == 4)

Mar27tornadoes <- HistoricalBigDayTornadoes %>% 
  filter(cDate == "1882-03-27", groupNumber == 4)

Mar27tornadoes <- Mar27tornadoes %>%
  mutate(Hour2 = ifelse(hour <= 6, hour + 24, hour))
```



**Make a map of the March 27 tornado day. Obtain the state and county boundaries from the `USAboundaries` package. Plot as an example of a historical cluster.**
```{r}
Mar27tornadoes$Hour2 <- cut(Mar27tornadoes$Hour2, breaks=c(6,12,18,24,30))

Mar1882 <- (tm_shape(stateBorders) + 
              tm_text("state_name") +
  tm_borders(col = "gray70", alpha = 1) +
  tm_compass(size = 3, fontsize = 1, lwd = 2, color.dark = "gray70") +       
  tm_scale_bar(width = .3, size = 0.8, lwd = 1.75, color.dark = "gray70") +
  tm_layout(legend.bg.color = "white", 
            legend.text.size = .75, 
            attr.position = c("left", "bottom"), 
            inner.margins = c(.3, .15, .3, .15)) +
#tm_shape(counties.sf) +
#  tm_borders(col = "gray40", alpha = .3) +
#  tm_scale_bar(width = 8, size = 8, color.dark = "gray70") +
  #tm_format("World", legend.position = c("right", "top"),
#                   attr.position = c("right", "top"),
#                   legend.frame = FALSE,
                   #title = "May 30th Tornado Group",
                   #title.size = 1.3,
                   #title.position = c("left", "TOP"),
 #                  inner.margins = c(.2, .2, .2, .2)) +
tm_shape(Mar27, is.master = TRUE, projection = "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs") +
  tm_borders(col = "black", lwd = 3) +
tm_shape(Mar27tornadoes) +
  tm_symbols(size = 4, col = "Hour2", alpha = 0.8, palette = "BuPu", title.col = "Time [CST]", labels = c("6 to 12", "12 to 18", "18 to 24", "0 to 6"), border.alpha = 0) +
      tm_layout(title = "March 27, 1882 \n 14 tornadoes", 
              title.position = c("center", "top"), 
              legend.title.size = 1.4,
              legend.position = c("right", "bottom"), 
              legend.stack = "horizontal",
              legend.frame = FALSE, 
              legend.text.size = 1.2, 
              legend.width = -0.2, 
              title.size = 1.5)
)

Mar1882
```


**Create a table of the Top 10 clusters based on the number of tornadoes that occurred. Obtain the maximum EF rating and total casualties for those days. **
```{r}
x <- HistoricalBigDays.sfdfT %>%
  dplyr::select(cDate, nT, maxEF, GroupDayCas) %>%
  arrange(desc(nT)) %>%
  head(10)

x<- st_drop_geometry(x)

print(xtable(x))
```

## Create Figure: Multiple clusters on a single convective day
```{r}

```



Separate the data between Weak, Strong, and Significant Tornadoes. 
```{r}
centroids <- st_centroid(HistoricalBigDays.sfdfT)
centroids.spatpoint <- as_Spatial(centroids)
WeakTorns <- (centroids) %>%
  filter(maxEF == "F1")
StrongTorns <- centroids %>%
  filter(maxEF == "F2" | maxEF == "F3") %>%
  as_Spatial()
SignificantTorns <- centroids %>%
  filter(maxEF == "F4" | maxEF == "F5") %>%
  as_Spatial
```

```{r}
sts <- state.name[!state.name %in% c("Alaska", "Hawaii")]
stateBorders <- us_states(states = sts)
```


```{r}
cr <- RColorBrewer::brewer.pal(9, "YlOrRd")
cr <- cr[-c(1:4)]
```

Plot the data for the tornado touchdown locations (`SigTorns`). Add a map of the United States. Color code the tornadoes by ORANGE: weak (F0, F1), RED: strong(F2, F3), BLACK: significant (F4, F5). 
```{r}
LargenT <- centroids %>%
  filter(nT >15) %>%
  as_Spatial()

cr <- RColorBrewer::brewer.pal(9, "Greens")
cr <- c("#E5F5E0","#74C476","#41AB5D", "#238B45","#006D2C", "#00441B")

torn <- (tm_shape(stateBorders) +
  #tm_text("state_abbr")+
  tm_borders(col = "gray70", alpha = 1) +
  tm_compass(size = 3, fontsize = 1, lwd = 2, color.dark = "gray70") +       
  tm_scale_bar(width = .3, size = 0.8, lwd = 1.75, color.dark = "gray70")  +
#tm_shape(WeakTorns) +
#  tm_bubbles(size = 0.1, col = "blue", border.col = "blue", alpha = 0.5) +
tm_shape(stateBorders[!stateBorders$stusps%in% c("MI", "LA", "FL"),], projection ="+init=epsg:2163") +
  tm_borders(alpha = 0.2) +
  tm_text('stusps') +
tm_shape(stateBorders[stateBorders$stusps == "MI",], projection ="+init=epsg:2163") +
  tm_borders(alpha = 0.2) +
  tm_text('stusps', ymod = -.75, xmod = .5) +
tm_shape(stateBorders[stateBorders$stusps == "LA",], projection ="+init=epsg:2163") +
  tm_borders(alpha = 0.2) +
  tm_text('stusps', ymod = .25, xmod = -.45) +
  tm_shape(stateBorders[stateBorders$stusps == "FL",], projection ="+init=epsg:2163") +
  tm_borders(alpha = 0.2) +
  tm_text('stusps', ymod = .25, xmod = .6) +
tm_shape(LargenT, is.master = TRUE, projection = "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs") +
  tm_bubbles(col = "nT", border.col = "black", alpha = 0.9, n=5, palette = cr, title.col = "Tornadoes", breaks = c(15, 30, 45, 60, 75, 90, 105)) +
tm_layout(main.title = "A", legend.show = TRUE,
          legend.position = c("right", "bottom"),
          legend.bg.color = "white",
          legend.text.size = 0.8,
          legend.title.size = 1.2,
          attr.position = c("left", "bottom"), 
          inner.margins = c(.3, .15, .15, .15)))

torn      
```

```{r}
cr <- RColorBrewer::brewer.pal(9, "Reds")
cr <- c("#FEE0D2", "#FC9272", "#EF3B2C", "#CB181D", "#A50F15", "#67000D")
```

```{r}
LargeCas <- centroids %>%
  filter(GroupDayCas >=500) %>%
  as_Spatial()

cas <- (tm_shape(stateBorders) +
          #tm_text("state_abbr")+
  tm_borders(col = "gray70", 
             alpha = 1) +
  tm_compass(size = 3, 
             fontsize = 1, 
             lwd = 2, 
             color.dark = "gray70") +       
  tm_scale_bar(width = .3, 
               size = 0.8, 
               lwd = 1.75, 
               color.dark = "gray70")  +
#tm_shape(WeakTorns) +
#  tm_bubbles(size = 0.1, col = "blue", border.col = "blue", alpha = 0.5) +
tm_shape(stateBorders[!stateBorders$stusps%in% c("MI", "LA", "FL"),], projection ="+init=epsg:2163") +
  tm_borders(alpha = 0.2) +
  tm_text('stusps') +
tm_shape(stateBorders[stateBorders$stusps == "MI",], projection ="+init=epsg:2163") +
  tm_borders(alpha = 0.2) +
  tm_text('stusps', ymod = -.75, xmod = .5) +
tm_shape(stateBorders[stateBorders$stusps == "LA",], projection ="+init=epsg:2163") +
  tm_borders(alpha = 0.2) +
  tm_text('stusps', ymod = .25, xmod = -.45) +
  tm_shape(stateBorders[stateBorders$stusps == "FL",], projection ="+init=epsg:2163") +
  tm_borders(alpha = 0.2) +
  tm_text('stusps', ymod = .25, xmod = .6) +
tm_shape(LargeCas, 
         is.master = TRUE, 
         projection = "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs") +
  
  tm_bubbles(col = "GroupDayCas", 
             border.col = "black", 
             alpha = 0.8, 
             palette = cr, 
             labels = c("500 to 1,000","1,001 to 2,000","2,001 to 3,000","3,001 to 4,000","4,001 to 5,000","5,001 to 6,000"), 
             title.col = "Casualties") +
tm_layout(main.title = "B", 
          legend.show =TRUE,
          legend.bg.color = "white",
          legend.position = c("right", "bottom"),
          legend.text.size = 0.8,
          legend.title.size = 1.2,
          attr.position = c("left", "bottom"), 
          inner.margins = c(.3, .15, .15, .15)))

cas
```

```{r}
tmap_arrange(torn, cas, nrow = 1)
```

Create a figure of the tornado cluster density plot for all of the tornadoes (A) and only the strongest tornadoes (B). 

Kernel Density: 

```{r}
library(extrafont)
#font_import()
#y
```


```{r}
library(scales)
ggplot(stateBorders) +
  geom_sf(fill = NA, col = "gray70") + 
  stat_density2d(aes(x = slon, y = slat, fill = stat(level)), alpha = .4, h = 4, contour = TRUE,
                 geom = "polygon", data = HistoricalBigDayTornadoes) +
  scale_fill_distiller(palette = "Greens", direction  = 1) +
  labs(x = "Longitude", y = "Latitude", fill = "Tornado Density") +
  #ggtitle("Density of Historical Clusters") +
  theme_bw() +
  #geom_sf(data = centroids, alpha = 0.4) +
  theme(plot.title = element_text(family = "Arial" , hjust = 0.5), legend.direction="horizontal", legend.position="bottom", legend.key.width = unit(1.5, 'cm')) #+
 # geom_point(data = HistoricalBigDayTornadoes, aes( x = slon, y = slat))


```

What is the temporal distribution of tornado clusters? Year on the x axis, counts on the y, stacked bars shaded by maximum F rating. Group by 50 years. 

```{r}
NumClusbyYear <- HistoricalBigDays.sfdfT %>%
  group_by(Year, maxEF) %>%
  summarize(count = n(),
            totTorn = sum(nT))
```

```{r}
numClus <- ggplot(NumClusbyYear) +
  geom_bar(aes(fill = maxEF, y = count, x = Year), position = "stack", stat = "identity") +
    geom_smooth(aes(y = count, x = Year), method = lm, se = FALSE, color = "red") +
  scale_fill_manual(values = c("slategray1", "steelblue2", "royalblue3", "navyblue")) +
  scale_x_continuous(expand = c(0, 0), limits = c(1880, 1990), breaks = seq(1880, 1990, 5)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 20), breaks = seq(0, 20,2)) +
  labs(x = "Year", y = "Number of Clusters") +
  theme_minimal()
```

```{r}
totTorn <- ggplot(NumClusbyYear) +
  geom_bar(aes(fill = maxEF, y = totTorn, x = Year), position = "stack", stat = "identity") +
    geom_smooth(aes(y = totTorn, x = Year), method = lm, se = FALSE, color = "red") +
  scale_fill_manual(values = c("slategray1", "steelblue2", "royalblue3", "navyblue")) +
  scale_x_continuous(expand = c(0, 0), limits = c(1880, 1990), breaks = seq(1880, 1990, 5)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 105), breaks = seq(0, 105,10)) +
  labs(x = "Year", y = "Number of Tornadoes") +
  theme_minimal()
```


```{r}
NumClusbyYear <- HistoricalBigDays.sfdfT %>%
  group_by(Year) %>%
  summarize(count = n(),
            totTorn = sum(nT),
            normalized = totTorn - 44,
            pos = normalized>=0)

NumClusbyYear
mean(NumClusbyYear$totTorn)

posTorn <- NumClusbyYear %>%
  filter(totTorn>=0)
negTorn <- NumClusbyYear %>%
  filter(totTorn<0)

test <- ggplot(NumClusbyYear) +
  geom_bar(aes(y = normalized, x = Year, fill = pos), position = "stack", stat = "identity") +
 # geom_bar(aes(y = totTorn, x = Year, fill = "blue"), position = "stack", stat = "identity") +
    #geom_smooth(aes(y = totTorn, x = Year), method = lm, se = FALSE, color = "red") +
  scale_fill_manual(values = c("slategray", "deeppink4"), name = "", labels = c("Below Normal", "Above Normal")) +
  scale_x_continuous(expand = c(0, 0), limits = c(1880, 1990), breaks = seq(1880, 1985, 5)) +
  scale_y_continuous(expand = c(-0, 0), limits = c(-50, 100), breaks = seq(-50, 100,10)) +
  labs(x = "Year", y = "Number of Tornadoes") +
  theme_minimal()
test + theme(legend.text = element_text(size=12),
              legend.position = "bottom", 
             legend.direction = "horizontal", 
             axis.text.x = element_text(angle = 45, margin = margin(t = 10)), 
            axis.title.x = element_text( margin = margin(t=10)), 
             axis.text.y = element_text(margin = margin(r = 10)), 
             axis.title.y = element_text( margin = margin(r=10)), 
             strip.text = element_text(size=16), 
             axis.text = element_text(size=12), 
             axis.title=element_text(size=14,face="bold"), 
             panel.grid.major.x = element_blank(),
             panel.grid.minor.x = element_blank())


```

```{r}
library(gridExtra)
grid.arrange(numClus,totTorn)
```

Number of tornadoes by month, stacked bars shaded by maximum F rating. 

```{r}
NumClusbyMonth <- HistoricalBigDays.sfdfT %>%
  group_by(Month, maxEF) %>%
  summarize(count = n())

ggplot(NumClusbyMonth, aes(fill = maxEF, y = count, x = Month)) +
  geom_bar(position = "stack", stat = "identity") +
  scale_fill_manual(values = c("slategray1", "steelblue2", "royalblue3", "navyblue")) +
  scale_x_discrete(expand = c(0, 0), labels = month.abb) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 125), breaks = seq(0, 130,10)) +
  labs(x = "Month", y = "Number of Clusters") +
  theme_minimal()
```

Map of maximum number of tornado days.

```{r}
centroids %>%
  group_by(Month) %>%
  summarize(numClus = n())

names <- array(month.name)

p <- (ggplot(stateBorders) +
  geom_sf(fill = NA, color = "gray70") + 
  stat_density2d(aes(x = slon, y = slat, fill = ..level..), alpha = .5, h = 5,
                 geom = "polygon", data = HistoricalBigDayTornadoes) +
  facet_wrap(~Ma, ncol = 3, labeller = labeller(Ma = 
                    c("Jan" = "January",
                      "Feb" = "February",
                      "Mar" = "March",
                      "Apr" = "April",
                      "May" = "May",
                      "Jun" = "June",
                      "Jul" = "July",
                      "Aug" = "August",
                      "Sep" = "September",
                      "Oct" = "October",
                      "Nov" = "November",
                      "Dec" = "December"))) +
    scale_fill_distiller(palette = "YlOrRd", direction  = 1) +
  labs(x = "Longitude", y = "Latitude") +#, fill = "Density") +
  #scale_fill_gradient(low = "#FCBBA1", high = "#99000D") + 
  theme_minimal())

p <- p + theme(axis.text.x = element_text(angle = 45, margin = margin(t = 20)), axis.text.y = element_text(margin = margin(r = 20)), axis.title.y = element_text( margin = margin(r=20)), strip.text = element_text(size=16), axis.text=element_text(size=12), axis.title=element_text(size=14,face="bold"), legend.position="none")

p
```

Figure of the number of clusters for each start hour of the day in CST. 

```{r}
NumClusbyHour <- HistoricalBigDays.sfdfT %>%
  group_by(Hour, maxEF) %>%
  summarize(count = n())

ggplot(NumClusbyHour, aes(fill = maxEF, y = count, x = Hour)) +
  geom_bar(position = "stack", stat = "identity") +
  scale_fill_manual(values = c("slategray1", "steelblue2", "royalblue3", "navyblue")) +
  scale_x_continuous(expand = c(0, 0), limits = c(-.5, 23.5), breaks = seq(0, 23,1)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 80), breaks = seq(0, 80,10)) +
  labs(x = "Hour (CST)", y = "Number of Clusters") +
  theme_minimal()
```

Figure: Separate by summer and winter and plot the clusters by hour. Separate to MAM, DJF, JJA, SON

```{r}
library(wesanderson)
pal <- wes_palette("Zissou1", 5, type = "continuous")
pal <- c("#78B7C5", "#EBCC2A", "#E1AF00", "#F21A00")
```


```{r}
MAM <- HistoricalBigDays.sfdfT %>%
  filter(Mo >=  3 & Mo <= 5)
NumClusbyHour_MAM <- MAM %>%
  group_by(Hour, maxEF) %>%
  summarize(count = n())

P1 <- ggplot(NumClusbyHour_MAM, aes(fill = maxEF, y = count, x = Hour)) +
  geom_bar(position = "stack", stat = "identity") +
  scale_fill_manual(values = pal, name = "Maximum Rating") +
  scale_x_continuous(expand = c(0, 0), limits = c(-.5, 23.5), breaks = seq(0, 23,1)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 50), breaks = seq(0, 50,10)) +
  labs(x = "Hour (CST)", y = "Number of Clusters") +
  theme_minimal() +
  ggtitle("MAM")

P1 <- P1 + theme(panel.grid.minor = element_blank(), axis.text.x = element_text(angle = 45, margin = margin(t = 10)), 
            axis.title.x = element_text( margin = margin(t=10)), 
             axis.text.y = element_text(margin = margin(r = 10)), 
             axis.title.y = element_text( margin = margin(r=10)), 
             strip.text = element_text(size=16), 
             axis.text = element_text(size=12), 
             axis.title=element_text(size=14,face="bold"))
P1
```

```{r}
JJA <- HistoricalBigDays.sfdfT %>%
  filter(Mo >= 6 & Mo <= 8)

NumClusbyHour_JJA <- JJA %>%
  group_by(Hour, maxEF) %>%
  summarize(count = n())

P2 <- ggplot(NumClusbyHour_JJA, aes(fill = maxEF, y = count, x = Hour)) +
  geom_bar(position = "stack", stat = "identity") +
  scale_fill_manual(values = pal, name = "Maximum Rating") +
    scale_x_continuous(expand = c(0, 0), limits = c(-.5, 23.5), breaks = seq(0, 23,1)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 50), breaks = seq(0, 50,10)) +
  labs(x = "Hour (CST)", y = "Number of Clusters") +
  theme_minimal() +
  ggtitle("JJA")

P2 <- P2 + theme(panel.grid.minor = element_blank(), axis.text.x = element_text(angle = 45, margin = margin(t = 10)), 
            axis.title.x = element_text( margin = margin(t=10)), 
             axis.text.y = element_text(margin = margin(r = 10)), 
             axis.title.y = element_text( margin = margin(r=10)), 
             strip.text = element_text(size=16), 
             axis.text = element_text(size=12), 
             axis.title=element_text(size=14,face="bold"))
P2
```

```{r}
SON <- HistoricalBigDays.sfdfT %>%
  filter(Mo >= 9 & Mo <= 11)

NumClusbyHour_SON <- SON %>%
  group_by(Hour, maxEF) %>%
  summarize(count = n())

P3 <- ggplot(NumClusbyHour_SON, aes(fill = maxEF, y = count, x = Hour)) +
  geom_bar(position = "stack", stat = "identity") +
  scale_fill_manual(values = pal, name = "Maximum Rating") +
    scale_x_continuous(expand = c(0, 0), limits = c(-.5, 23.5), breaks = seq(0, 23,1)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 50), breaks = seq(0, 50,10)) +
  labs(x = "Hour (CST)", y = "Number of Clusters") +
  theme_minimal() +
  ggtitle("SON")

P3 <- P3 + theme(panel.grid.minor = element_blank(), axis.text.x = element_text(angle = 45, margin = margin(t = 10)), 
            axis.title.x = element_text( margin = margin(t=10)), 
             axis.text.y = element_text(margin = margin(r = 10)), 
             axis.title.y = element_text( margin = margin(r=10)), 
             strip.text = element_text(size=16), 
             axis.text = element_text(size=12), 
             axis.title=element_text(size=14,face="bold"))
P3
```

```{r}
DJF <- HistoricalBigDays.sfdfT %>%
  filter(Mo <= 2 | Mo >= 12)

NumClusbyHour_DJF <- DJF %>%
  group_by(Hour, maxEF) %>%
  summarize(count = n())

P4 <- ggplot(NumClusbyHour_DJF, aes(fill = maxEF, y = count, x = Hour)) +
  geom_bar(position = "stack", stat = "identity") +
  scale_fill_manual(values = pal, name = "Maximum Rating") +
  scale_x_continuous(expand = c(0, 0), limits = c(-.5, 23.5), breaks = seq(0, 23,1)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 50), breaks = seq(0, 50,10)) +
  labs(x = "Hour (CST)", y = "Number of Clusters") +
  theme_minimal() +
  ggtitle("DJF")

P4 <- P4 + theme(panel.grid.minor = element_blank(), axis.text.x = element_text(angle = 45, margin = margin(t = 10)), 
            axis.title.x = element_text( margin = margin(t=10)), 
             axis.text.y = element_text(margin = margin(r = 10)), 
             axis.title.y = element_text( margin = margin(r=10)), 
             strip.text = element_text(size=16), 
             axis.text = element_text(size=12), 
             axis.title=element_text(size=14,face="bold"))
P4

```

```{r}
library(gridExtra)
library(ggpubr)
ggarrange(P4, P1, P2, P3, common.legend = TRUE, legend = "bottom")
```


Figure: Annual # of casualties from tornadoes with their respective F-scale ratings color coded. 

```{r}
test2 <- HistoricalBigDays.sfdfT %>%
  filter(maxEF == "F2")
test3 <- HistoricalBigDays.sfdfT %>%
  filter(maxEF == "F3")
test4 <- HistoricalBigDays.sfdfT %>%
  filter(maxEF == "F4")
test5 <- HistoricalBigDays.sfdfT %>%
  filter(maxEF == "F5")

test2 <- test2 %>%
  group_by(Year) %>%
  summarize(count = sum(GroupDayCas))
test3 <- test3 %>%
  group_by(Year) %>%
  summarize(count = sum(GroupDayCas))
test4 <- test4 %>%
  group_by(Year) %>%
  summarize(count = sum(GroupDayCas))
test5 <- test5 %>%
  group_by(Year) %>%
  summarize(count = sum(GroupDayCas))

#test$count[test$count == "NA"] <- 0
```

```{r}
F2 <- ggplot(test2, aes(y = count, x = Year)) +
  geom_bar(fill = "slategray1", position = "stack", stat = "identity") +
  scale_x_continuous(expand = c(0, 0), limits = c(1875, 1986), breaks = seq(1875, 1986,5)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 1000), breaks = seq(0, 6000,100)) +
  labs(x = "Year", y = "Number of Casualties") +
  theme_bw() + theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))+
  ggtitle("A")
```

```{r}
F3 <- ggplot(test3, aes(y = count, x = Year)) +
  geom_bar(fill = "steelblue2", position = "stack", stat = "identity") +
  scale_x_continuous(expand = c(0, 0), limits = c(1875, 1986), breaks = seq(1875, 1986,5)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 1000), breaks = seq(0, 1000,100)) +
  labs(x = "Year", y = "Number of Casualties") +
  theme_bw() + theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))+
  ggtitle("B") 
```

```{r}
F4 <- ggplot(test4, aes(y = count, x = Year)) +
  geom_bar(fill = "royalblue3", position = "stack", stat = "identity") +
  scale_x_continuous(expand = c(0, 0), limits = c(1875, 1986), breaks = seq(1875, 1986,5)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 6000), breaks = seq(0, 6000,500)) +
  labs(x = "Year", y = "Number of Casualties") +
  theme_bw() + theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))+
  ggtitle("C") 
```

```{r}
F5 <- ggplot(test5, aes(y = count, x = Year)) +
  geom_bar(fill = "navyblue", position = "stack", stat = "identity") +
  scale_x_continuous(expand = c(0, 0), limits = c(1875, 1986), breaks = seq(1875, 1986,5)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 6000), breaks = seq(0, 6000,500)) +
  labs(x = "Year", y = "Number of Casualties") +
    theme_bw() + theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) +
  ggtitle("D") 
```

```{r}
grid.arrange(F2, F3, F4, F5)
```

Table: Avg # injuries and fatalities per tornado event. Separate by decade and calculate frequency, # fatalities, # of injuries all by rating. 

```{r}
omg <- HistoricalBigDays.sfdfT %>%
  mutate(decade = round(Year/10) * 10) 
  

x <- omg %>%
  group_by(decade) %>%
  summarize(NumClus = n(), 
            NumTorn = sum(nT),
            totcas = sum(GroupDayCas, na.rm = TRUE),
            freq = NumClus/dim(HistoricalBigDays.sfdfT)[1] * 100, 
            tot = NumTorn/NumClus)

```

```{r}
x$decade <- as.factor(x$decade)

ggplot(HistoricalBigDays.sfdfT) + geom_boxplot(aes(Year, y = nT, group = cut_width(Year, 10))) 
```


##Number of Casualties: 

1. Create a figure of casualties over time

2. Create a figure of total casualties by month with the 4 F ratings as separate bars. 

********************************************************************

April 3, 1974
ID: 
```{r}
Apr3 <- HistoricalBigDays.sfdfT %>%
  filter(cDate == "1974-04-03", groupNumber == 288)
Apr3area <- st_convex_hull(Apr3)
st_area(Apr3area)
Apr3 <- as_Spatial(st_convex_hull(Apr3))

Apr3centroid <- centroids %>%
  filter(cDate == "1974-04-03", groupNumber == 288)%>%
  as_Spatial()

Apr3tornadoes <- HistoricalBigDayTornadoes %>% 
  filter(cDate == "1974-04-03", groupNumber == 288)

Apr3tornadoes <- Apr3tornadoes %>%
  mutate(Hour2 = ifelse(hour <= 6, hour + 24, hour)) %>%
  as_Spatial
```

**Make a map of the APRIL 3 1974 tornado day. Obtain the state and county boundaries from the `USAboundaries` package. **
```{r}
Apr3tornadoes$Hour2 <- cut(Apr3tornadoes$Hour2, breaks=c(6,12,18,24,30))

Apr31974 <- (tm_shape(stateBorders) +
               tm_text("state_name") +
  tm_borders(col = "gray70", alpha = 1) +
  tm_compass(size = 3, fontsize = 1, lwd = 2, color.dark = "gray70") +       
  tm_scale_bar(width = .3, size = 0.8, lwd = 1.75, color.dark = "gray70") +
  tm_layout(legend.bg.color = "white", 
            legend.text.size = .75, 
            attr.position = c("left", "bottom"), 
            inner.margins = c(.15, .15, .15, .15)) +
#tm_shape(counties.sf) +
#  tm_borders(col = "gray40", alpha = .3) +
#  tm_scale_bar(width = 8, size = 8, color.dark = "gray70") +
  #tm_format("World", legend.position = c("right", "top"),
#                   attr.position = c("right", "top"),
#                   legend.frame = FALSE,
                   #title = "May 30th Tornado Group",
                   #title.size = 1.3,
                   #title.position = c("left", "TOP"),
 #                  inner.margins = c(.2, .2, .2, .2)) +
tm_shape(Apr3, is.master = TRUE, projection = "+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs") +
  tm_borders(col = "black", lwd = 3) +
tm_shape(Apr3tornadoes) +
  tm_symbols(size = 4, col = "Hour2", alpha = 0.8, palette = "BuPu", title.col = "Time [CST]", labels = c("6 to 12", "12 to 18", "18 to 24", "0 to 6"), border.alpha = 0) +
    tm_layout(legend.title.size = 1.1,
            legend.position = c("right", "bottom"), 
            legend.stack = "horizontal",
            legend.frame = FALSE, 
            legend.text.size = 1, legend.width = -0.2) +
tm_shape(Apr3centroid) +
  tm_symbols(size = 1.25, col = "black", shape = 24)  +
  tm_layout(title = "April 3, 1974 \n 94 tornadoes", 
              title.position = c("center", "top"), 
              legend.title.size = 1.4,
              legend.position = c("right", "bottom"), 
              legend.stack = "horizontal",
              legend.frame = FALSE, 
              legend.text.size = 1.2, 
              legend.width = -0.2, 
              title.size = 1.5)
)

Apr31974
```

```{r}
HistoricalBigDayTornadoes %>%
  group_by(st) %>%
  arrange(desc(nC)) %>%
  head(10)
```

```{r}
library(stats)

x <- as.data.frame(x)

t.test(x$decade, NumClus,  data = x)
t.test(x$decade, x$NumTorn,  data = x)
t.test(x$decade, x$totcas,  data = x)

yo <- x
  ggplot(yo, aes(x= decade, y = totcas)) +
  geom_line()

  wilcox.test(x$decade, x$NumTorn)
  wilcox.test(x$decade, x$totcas)
  wilcox.test(x$decade, x$NumClus)
  
  install.packages("tseries")
  library(tseries)
  adf.test()
```


